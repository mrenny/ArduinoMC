<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Project Results | The Plant Sitter</title> <meta name="generator" content="Jekyll v4.3.0" /> <meta property="og:title" content="Project Results" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A project in fulfillment of the Arduino Microcredential at CU Boulder Spring 2023" /> <meta property="og:description" content="A project in fulfillment of the Arduino Microcredential at CU Boulder Spring 2023" /> <link rel="canonical" href="http://localhost:4000/4.Project.html" /> <meta property="og:url" content="http://localhost:4000/4.Project.html" /> <meta property="og:site_name" content="The Plant Sitter" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Project Results" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A project in fulfillment of the Arduino Microcredential at CU Boulder Spring 2023","headline":"Project Results","url":"http://localhost:4000/4.Project.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> The Plant Sitter </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/2.Checklist.html" class="nav-list-link">Microcredential Checklist</a></li><li class="nav-list-item"><a href="/3.Project%20Charter.html" class="nav-list-link">Project Charter</a></li><li class="nav-list-item active"><a href="/4.Project.html" class="nav-list-link active">Project Results</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search The Plant Sitter" aria-label="Search The Plant Sitter" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/just-the-docs/just-the-docs-template" class="site-button" > Template Repository </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h2 class="no_toc" id="project-results"> <a href="#project-results" class="anchor-heading" aria-labelledby="project-results"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Project Results </h2> <ul id="markdown-toc"> <li><a href="#project-repository" id="markdown-toc-project-repository">Project Repository</a></li> <li><a href="#overview-of-plant-sitter" id="markdown-toc-overview-of-plant-sitter">Overview of Plant Sitter</a></li> <li><a href="#code" id="markdown-toc-code">Code</a> <ul> <li><a href="#included-libraries" id="markdown-toc-included-libraries">Included Libraries</a></li> <li><a href="#global-declarations" id="markdown-toc-global-declarations">Global Declarations</a></li> <li><a href="#writeble" id="markdown-toc-writeble">writeBLE</a></li> <li><a href="#setup" id="markdown-toc-setup">setup</a></li> <li><a href="#writemenu" id="markdown-toc-writemenu">writeMenu</a></li> <li><a href="#getdata" id="markdown-toc-getdata">getData</a></li> <li><a href="#writecharacteristichandler" id="markdown-toc-writecharacteristichandler">writeCharacteristicHandler</a></li> <li><a href="#waternow" id="markdown-toc-waternow">waterNow</a></li> <li><a href="#closeshade" id="markdown-toc-closeshade">closeShade</a></li> <li><a href="#openshade" id="markdown-toc-openshade">openShade</a></li> <li><a href="#heaton" id="markdown-toc-heaton">heatOn</a></li> <li><a href="#getdtskip" id="markdown-toc-getdtskip">getDtSkip</a></li> <li><a href="#loop" id="markdown-toc-loop">loop</a></li> </ul> </li> <li><a href="#validation" id="markdown-toc-validation">Validation</a></li> <li><a href="#future-work" id="markdown-toc-future-work">Future Work</a></li> </ul> <h3 id="project-repository"> <a href="#project-repository" class="anchor-heading" aria-labelledby="project-repository"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Project Repository </h3> <p>All firmware can be found at the Git Hub repository linked through the following button:</p> <p><a href="https://github.com/mrenny/ArduinoMC" class="btn btn-outline">Go to Repository</a></p> <p>Or, to quickly copy and paste the code into your own IDE, either find the code within the ArduinoFirmware folder of the repository or click here:</p> <p><a href="https://github.com/mrenny/ArduinoMC/blob/main/PlantSitterFirmware/microcredential.ino" class="btn btn-outline">Go to Code</a></p> <h3 id="overview-of-plant-sitter"> <a href="#overview-of-plant-sitter" class="anchor-heading" aria-labelledby="overview-of-plant-sitter"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview of Plant Sitter </h3> <p>The Plant Sitter is a BLE device that operates as “idle state central device, active state peripheral device,” or “ICAP”. This allows it to utilize the low power consumption that BLE protocol offers, while being able to swtich between being both host and client.</p> <p>In its idle state as a central device, it continuously logs data about the environment, user inputs, and its own actions to its on board memory. When connection is made with a peripheral device, it offers a menu of choices to the user, receives and handles choices appropriately.</p> <p>If the choice “View/Export Data” is received, the Plant Sitter restarts its BLE service in Peripheral Mode. Once switched, the Plant Sitter broadcasts live data for about 10 minutes It then let’s the user know that it will be switching back to data logging mode, and goes back to central mode where it can receive new requests.</p> <p><img src="/assets/images/DataFlow.png" alt="image" /></p> <p>This device is a demonstration of how Bluetooth protocls can be used to wirelessly communicate with a single Plant Sitter. While BLE is used for this device, classic Bluetooth could be employed to increase the tranmission distance to the desired 100 m. This number comes from the popular unit of area for land, the hectare [100 m x 100 m], where the density of a potentiostat’s sensnsing arary could be expected to be about 1 sensing node per hectare. Therefore, assuming a grid-like implementation, one Plant Sitter would only be needed ever 4 hectares.</p> <h3 id="code"> <a href="#code" class="anchor-heading" aria-labelledby="code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Code </h3> <p>This section is devoted to showcasing the code as well as deep commenting. For an easily downloadable and useable version of the code, please visit the GitHub Repository located at the URL at the top of the page.</p> <h4 id="included-libraries"> <a href="#included-libraries" class="anchor-heading" aria-labelledby="included-libraries"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Included Libraries </h4> <p>The only required libraries include the drivers for the sensors, clock, BLE, SD, and SPI. All other components can be controlled or communicated with via digital and analog reads.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cp">#include</span> <span class="cpf">&lt;Arduino_HS300x.h&gt;</span><span class="c1">//onboard  temp/humidity sensor</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;Arduino_LPS22HB.h&gt;</span><span class="c1">//onboard barometer</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;Adafruit_AS7341.h&gt;</span><span class="c1">//10 channel spectrometer</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">"RTClib.h"</span><span class="c1">//clock</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="c1">//Protocol for SPI</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;SD.h&gt;</span><span class="c1">//Protocol for file system</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;Wire.h&gt;</span><span class="c1">//Protocol for I2C</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;ArduinoBLE.h&gt;</span><span class="c1">//Protocol for BLE</span><span class="cp">
</span></code></pre></div></div> <h4 id="global-declarations"> <a href="#global-declarations" class="anchor-heading" aria-labelledby="global-declarations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Global Declarations </h4> <p>Here we declare at the top of the code two different types of BLE characteristics required for ICAP. By default it will chose “receive” unless there are errors connecting to peripherals or the user specifically requested it go to “transfer” Global variables with no default value are often populated from the attached SD card which acts as nonvolatile memory.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//BLE Definitions</span>
  <span class="n">BLEService</span> <span class="nf">myService</span><span class="p">(</span><span class="s">"0000ffe0-0000-1000-8000-00805f9b34fb"</span><span class="p">);</span> <span class="c1">// service characteristic</span>
  <span class="n">BLECharacteristic</span> <span class="nf">receive</span><span class="p">(</span><span class="s">"EFE5"</span><span class="p">,</span> <span class="n">BLEIndicate</span> <span class="o">|</span> <span class="n">BLEWriteWithoutResponse</span> <span class="p">,</span><span class="mh">0x20</span><span class="p">);</span>
  <span class="n">BLECharacteristic</span> <span class="nf">transfer</span><span class="p">(</span><span class="s">"FFE1"</span><span class="p">,</span> <span class="n">BLEWrite</span> <span class="o">|</span> <span class="n">BLENotify</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span> 
  <span class="kt">char</span> <span class="n">bleMode</span><span class="p">;</span> <span class="c1">// will be t or r</span>
  <span class="kt">int</span> <span class="n">wake</span><span class="p">;</span>
<span class="c1">//Instrument Definitions/Pin Assignments</span>
  <span class="n">Adafruit_AS7341</span> <span class="n">as7341</span><span class="p">;</span>
  <span class="n">RTC_PCF8563</span> <span class="n">rtc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">sd</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="c1">//SD card CS pin</span>
  <span class="kt">int</span> <span class="n">pumpPin</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span><span class="c1">//pin pump vcc is connected to</span>
  <span class="kt">int</span> <span class="n">heatPin</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span><span class="c1">//pin heating pad is connected to</span>
  <span class="kt">int</span> <span class="n">shade0</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span><span class="c1">//pin for motor enable [can be 3V] as long as Vs and Vss are 5V https://www.arduino.cc/documents/datasheets/H-bridge_motor_driver.PDF</span>
  <span class="kt">int</span> <span class="n">shade1</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span><span class="c1">//pin for motor direction 1</span>
  <span class="kt">int</span> <span class="n">shade2</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span><span class="c1">//pin for motor direction 2</span>
  <span class="kt">int</span> <span class="n">moist</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="c1">//pin for ADC reading of soil sensor</span>
  <span class="kt">int</span> <span class="n">reset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span> <span class="c1">//pin attached to reset pin</span>
  <span class="kt">int</span> <span class="n">calSoil</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span><span class="c1">//pin for callibrating soil moisture sensor</span>
  <span class="kt">int</span> <span class="n">klock</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span><span class="c1">//pin to check</span>
  <span class="kt">int</span> <span class="n">R</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span><span class="c1">//onboard RGB LED</span>
  <span class="kt">int</span> <span class="n">G</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span><span class="c1">//onboard RGB LED</span>
  <span class="kt">int</span> <span class="n">B</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span><span class="c1">//onboard RGB LED</span>
  <span class="n">File</span> <span class="n">myFile</span><span class="p">;</span>
<span class="c1">//Global Variables</span>
  <span class="kt">int</span> <span class="n">skip</span><span class="p">;</span><span class="c1">//number of measurements to skip</span>
  <span class="kt">int</span> <span class="n">dt</span><span class="p">;</span><span class="c1">//measurement interval in ms</span>
  <span class="kt">float</span> <span class="n">t</span><span class="p">;</span><span class="c1">//temperature value</span>
  <span class="kt">float</span> <span class="n">rh</span><span class="p">;</span><span class="c1">//relative humidity value</span>
  <span class="kt">float</span> <span class="n">p</span><span class="p">;</span><span class="c1">//pressure value</span>
  <span class="kt">float</span> <span class="n">VPD</span><span class="p">;</span><span class="c1">//VPD value</span>
  <span class="kt">int</span> <span class="n">soil</span><span class="p">;</span><span class="c1">//soil moisture ADC reading</span>
  <span class="kt">float</span> <span class="n">soilP</span><span class="p">;</span><span class="c1">//soil moisture in percentage</span>
  <span class="kt">float</span> <span class="n">setT</span><span class="p">;</span><span class="c1">//temperature setpoint</span>
  <span class="kt">float</span> <span class="n">setW</span><span class="p">;</span><span class="c1">//soil set point</span>
  <span class="kt">int</span> <span class="n">soilDry</span><span class="p">;</span><span class="c1">//soil dry end callibration value</span>
  <span class="kt">int</span> <span class="n">soilWet</span><span class="p">;</span><span class="c1">//soil wet end callibration value</span>
  <span class="kt">int</span> <span class="n">instErr</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span><span class="c1">//error on T&amp;RH, P, PAR, and SD </span>
</code></pre></div></div> <h4 id="writeble"> <a href="#writeble" class="anchor-heading" aria-labelledby="writeble"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> writeBLE </h4> <p>This function can be used in both modes to send strings to the phone app.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">byte</span> <span class="n">plain</span><span class="p">[</span><span class="n">message</span><span class="p">.</span><span class="n">length</span><span class="p">()];</span> <span class="c1">// message buffer</span>
  <span class="n">message</span><span class="p">.</span><span class="n">getBytes</span><span class="p">(</span><span class="n">plain</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">length</span><span class="p">());</span> <span class="c1">// convert to bytes</span>
  <span class="n">receive</span><span class="p">.</span><span class="n">writeValue</span><span class="p">(</span><span class="n">plain</span><span class="p">,</span><span class="n">message</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
</code></pre></div></div> <h4 id="setup"> <a href="#setup" class="anchor-heading" aria-labelledby="setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> setup </h4> <p>Setup is responsible for a lot of things including normal stuff like setting pin modes and initializing instruments, but also for checking if the user is trying to callibrate the clock or soil sensor, and doing those callibrations before moving on. It also initalizes the SD card and uses values from pre-loaded files to populate global variables like setpoints for soil moisture and temperature.</p> <p>The most important things it does is begins the BLE service in the correct mode. By default, it will be set to act in RX mode where it is reading/receiving information from the phone. However, if it receives a request to push data to the phone, it softresets itself in transmit mode.</p> <p>While in transmission mode, it cannot take in commands, and it, currently, set to show the user 10 live data points [at whatever interval the measurement invertal is set to] before timing out and switching back to receiving mode. While in transmission mode, however, it does continue to log and save the data being sent to the user.</p> <p>An important variable, WAKE, is called in this function before BLE is advertised. This WAKE variable will be discussed in a later section dealing with how the Plant Sitter handles requests.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">//Set Pin Modes</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span><span class="c1">//Set RBG Pins</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">pumpPin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">heatPin</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">shade0</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">shade1</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">shade2</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">moist</span><span class="p">,</span><span class="n">INPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">klock</span><span class="p">,</span><span class="n">INPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">calSoil</span><span class="p">,</span><span class="n">INPUT</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pumpPin</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">shade0</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span><span class="c1">//Active High [not being reset]</span>
  <span class="c1">//Start and Set Clock time</span>
    <span class="c1">//If we're programming the board for the first time, its connected to Serial and will get the current date/time from the computer uploading the firmware</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">klock</span><span class="p">)){</span><span class="c1">//This will be false later when the jumper wire is removed/cut before packaging the circuit into its housing</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtc</span><span class="p">.</span><span class="n">begin</span><span class="p">()){</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Error connecting to the RTC. Makesure clock pin is shorted high"</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">rtc</span><span class="p">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">__DATE__</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="n">__TIME__</span><span class="p">)));</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="n">rtc</span><span class="p">.</span><span class="n">begin</span><span class="p">();}</span>
    <span class="c1">//Note that because the clock will be set before packaging, there is no error handling for this. It either works or it doesn't</span>
  <span class="c1">//Initialize SD Card to decide if device /should/ be receiving [default] or sending data</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SD</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">sd</span><span class="p">)){</span><span class="c1">//If SD doesn't begin, raise error flag, turn on LED, keep going in transmit mode so we can see what the error is from a phone</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span><span class="c1">//active low</span>
      <span class="n">bleMode</span> <span class="o">=</span> <span class="sc">'t'</span><span class="p">;</span><span class="c1">//default to sending information</span>
      <span class="n">instErr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="c1">//raise error flag</span>
    <span class="p">}</span> <span class="k">else</span><span class="p">{</span><span class="c1">//Otherwise the SD card began and we can at least /try/ to see what mode we wanted to be in</span>
    <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"BLE.txt"</span><span class="p">);</span><span class="c1">//File on pre-formattted/written SD card to store t or r;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">myFile</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
        <span class="n">bleMode</span> <span class="o">=</span> <span class="n">myFile</span><span class="p">.</span><span class="n">peek</span><span class="p">();</span><span class="c1">//there should be only be t or r. Peek allows me to check multiple times at the same location in the event a line break or extra character is present</span>
        <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="c1">//Callibrate the Soil Moisture sensor</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">calSoil</span><span class="p">)){</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Change Serial to 'No Line Ending' then Put Sensor in Dry State"</span><span class="p">);</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"When Satisfied Send Any Message Over Serial"</span><span class="p">);</span>
      <span class="k">while</span><span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
        <span class="n">soilDry</span> <span class="o">=</span> <span class="n">analogRead</span><span class="p">(</span><span class="n">moist</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">soil</span><span class="p">));</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"soilDry.txt"</span><span class="p">,</span><span class="n">O_WRITE</span><span class="p">);</span><span class="c1">//File on pre-formattted/written SD card to store t or r;</span>
      <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">soilDry</span><span class="p">));</span>
      <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Now Submerge Sensor in Wet State"</span><span class="p">);</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"When Satisfied Send Any Message Over Serial"</span><span class="p">);</span>
      <span class="k">while</span><span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
        <span class="n">soilWet</span> <span class="o">=</span> <span class="n">analogRead</span><span class="p">(</span><span class="n">moist</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">soil</span><span class="p">));</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"soilWet.txt"</span><span class="p">,</span><span class="n">O_WRITE</span><span class="p">);</span><span class="c1">//File on pre-formattted/written SD card to store t or r;</span>
      <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">soilWet</span><span class="p">));</span>
      <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="c1">//Initialize instruments; if one doesn't work, Red LED will turn on and instErr value will turn from 0 to 1; Also populate the desired setPoints from files</span>
    <span class="c1">//Initialize the temp/humidity sensor. It should just work because this is inside the uC</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HS300x</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">digitalWrite</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span><span class="c1">//active low</span>
        <span class="n">bleMode</span><span class="o">=</span><span class="sc">'t'</span><span class="p">;</span>
        <span class="n">instErr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"tsp.txt"</span><span class="p">);</span><span class="c1">//File on pre-formattted/written SD card to store t or r;</span>
      <span class="n">String</span> <span class="n">tempSP</span><span class="o">=</span><span class="s">""</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span><span class="n">myFile</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
        <span class="n">tempSP</span> <span class="o">=</span> <span class="n">tempSP</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">myFile</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="n">setT</span> <span class="o">=</span> <span class="n">tempSP</span><span class="p">.</span><span class="n">toFloat</span><span class="p">();</span>
    <span class="c1">//Populate Soil Moisture Set Point</span>
      <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"wsp.txt"</span><span class="p">);</span><span class="c1">//File on pre-formattted/written SD card to store t or r;</span>
      <span class="n">String</span> <span class="n">soilSP</span><span class="o">=</span><span class="s">""</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span><span class="n">myFile</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
        <span class="n">soilSP</span> <span class="o">=</span> <span class="n">soilSP</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">myFile</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="n">setW</span> <span class="o">=</span> <span class="n">soilSP</span><span class="p">.</span><span class="n">toFloat</span><span class="p">();</span>
    <span class="c1">//Initialize the barometer</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BARO</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">digitalWrite</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span><span class="c1">//active low</span>
        <span class="n">bleMode</span><span class="o">=</span><span class="sc">'t'</span><span class="p">;</span>
        <span class="n">instErr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;}</span>
    <span class="c1">//Initialize the PAR meter</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">as7341</span><span class="p">.</span><span class="n">begin</span><span class="p">()){</span>
        <span class="n">digitalWrite</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span><span class="c1">//active low</span>
        <span class="n">bleMode</span><span class="o">=</span><span class="sc">'t'</span><span class="p">;</span>
        <span class="n">instErr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">as7341</span><span class="p">.</span><span class="n">setATIME</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
      <span class="n">as7341</span><span class="p">.</span><span class="n">setASTEP</span><span class="p">(</span><span class="mi">999</span><span class="p">);</span>
      <span class="n">as7341</span><span class="p">.</span><span class="n">setGain</span><span class="p">(</span><span class="n">AS7341_GAIN_256X</span><span class="p">);</span>

    <span class="c1">//Initialize DataAquisition Variables</span>
      <span class="n">getDtSkip</span><span class="p">();</span>
  <span class="c1">//Initalize BLE based on requested mode/Service</span>
    <span class="c1">//Start up BLE and flash blue LED</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">BLE</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span> <span class="c1">//Blink blue LED while waiting for BLE to start</span>
        <span class="n">digitalWrite</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
        <span class="n">digitalWrite</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="c1">//Add approprite characteristic to service</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">bleMode</span> <span class="o">==</span> <span class="sc">'t'</span><span class="p">){</span>
        <span class="n">myService</span><span class="p">.</span><span class="n">addCharacteristic</span><span class="p">(</span><span class="n">transfer</span><span class="p">);</span> 
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">myService</span><span class="p">.</span><span class="n">addCharacteristic</span><span class="p">(</span><span class="n">receive</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">BLE</span><span class="p">.</span><span class="n">addService</span><span class="p">(</span><span class="n">myService</span><span class="p">);</span> <span class="c1">// add service to BLE dev</span>
      <span class="n">BLEAdvertisingData</span> <span class="n">scanData</span><span class="p">;</span> <span class="c1">// Build scan response data packet</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">bleMode</span> <span class="o">==</span><span class="sc">'r'</span><span class="p">){</span>
        <span class="n">scanData</span><span class="p">.</span><span class="n">setLocalName</span><span class="p">(</span><span class="s">"PlantSitterRemote"</span><span class="p">);</span> <span class="c1">// set BLE name</span>
        <span class="n">BLE</span><span class="p">.</span><span class="n">setDeviceName</span><span class="p">(</span><span class="s">"PlantSitterRemote"</span><span class="p">);</span> <span class="c1">// set BLE name</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">scanData</span><span class="p">.</span><span class="n">setLocalName</span><span class="p">(</span><span class="s">"PlantSitterData"</span><span class="p">);</span> <span class="c1">// set BLE name</span>
        <span class="n">BLE</span><span class="p">.</span><span class="n">setDeviceName</span><span class="p">(</span><span class="s">"PlantSitterData"</span><span class="p">);</span> <span class="c1">// set BLE name</span>
      <span class="p">}</span>
      <span class="n">BLE</span><span class="p">.</span><span class="n">setScanResponseData</span><span class="p">(</span><span class="n">scanData</span><span class="p">);</span> <span class="c1">// set name for scanners</span>
    <span class="c1">//Start handler if needed</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">bleMode</span> <span class="o">==</span> <span class="sc">'r'</span><span class="p">){</span><span class="c1">//this isn't needed for transmitting data because we don't need an event handler when sending things</span>
        <span class="n">receive</span><span class="p">.</span><span class="n">setEventHandler</span><span class="p">(</span><span class="n">BLEWritten</span><span class="p">,</span> <span class="n">WriteCharacteristicHandler</span><span class="p">);</span> <span class="c1">// add written handler</span>
      <span class="p">}</span>
    <span class="c1">//Advertise BLE</span>
      <span class="n">wake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//we only just started so the user is likely only just signing on!</span>
      <span class="n">BLE</span><span class="p">.</span><span class="n">advertise</span><span class="p">();</span> <span class="c1">// advertise BLE from MakerBLE board</span>
  <span class="c1">//If in transmission mode, send data to phone and restart</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bleMode</span> <span class="o">==</span> <span class="sc">'t'</span><span class="p">){</span>
      <span class="kt">int</span> <span class="n">stay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">timeOUT</span> <span class="o">=</span> <span class="n">dt</span><span class="o">*</span><span class="mi">10</span><span class="p">;</span>
    <span class="c1">//Declare self a central device</span>
      <span class="n">BLEDevice</span> <span class="n">central</span> <span class="o">=</span> <span class="n">BLE</span><span class="p">.</span><span class="n">central</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">central</span><span class="p">)</span> <span class="p">{</span><span class="c1">//if a connection is made</span>
    <span class="c1">//check if there are any errors we need to make alerts about</span>
        <span class="kt">int</span> <span class="n">errCheck</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
          <span class="n">errCheck</span><span class="o">=</span><span class="n">errCheck</span> <span class="o">+</span> <span class="n">instErr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="c1">//If errors, ONLY ADVERTISE which things are in error. Wait for physical restart</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">errCheck</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
          <span class="k">while</span> <span class="p">(</span><span class="n">central</span><span class="p">.</span><span class="n">connected</span><span class="p">()){</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
              <span class="k">switch</span><span class="p">(</span><span class="n">i</span><span class="p">){</span>
                <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">instErr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
                  <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Temperature and Humidity Sensor Error"</span><span class="p">);}</span>
                  <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">instErr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
                  <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Pressure Sensor Error"</span><span class="p">);}</span>
                  <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">instErr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
                <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Light Sensor Error"</span><span class="p">);}</span>
                  <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">instErr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
                  <span class="n">writeBLE</span><span class="p">(</span><span class="s">"SD Card Error"</span><span class="p">);}</span>
                  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
    <span class="c1">//If no errors, send/save data normally.</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">while</span> <span class="p">(</span><span class="n">central</span><span class="p">.</span><span class="n">connected</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">stay</span> <span class="o">&lt;</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Get data, save, display, and try to fix values far from set points since we are not able to control them in TX mode[Could honestly be in a function or something idk...]</span>
            <span class="n">String</span> <span class="n">strToPrint</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span> <span class="c1">// string to print </span>
            <span class="c1">//Save the time</span>
              <span class="n">digitalWrite</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
              <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"DATA.txt"</span><span class="p">,</span><span class="n">FILE_WRITE</span><span class="p">);</span>
              <span class="n">DateTime</span> <span class="n">now</span> <span class="o">=</span> <span class="n">rtc</span><span class="p">.</span><span class="n">now</span><span class="p">();</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">year</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">year</span><span class="p">());</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">month</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">month</span><span class="p">());</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">day</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">day</span><span class="p">());</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">hour</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">hour</span><span class="p">());</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">minute</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">minute</span><span class="p">());</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">second</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">second</span><span class="p">());</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
            <span class="c1">//Save Temperature</span>
              <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">HS300x</span><span class="p">.</span><span class="n">readTemperature</span><span class="p">();</span><span class="c1">//get temp in C</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">setT</span><span class="o">*</span><span class="mf">0.90</span><span class="p">){</span>
                <span class="n">heatOn</span><span class="p">();</span>
              <span class="p">}</span>
            <span class="c1">//Save Soil Moisture</span>
              <span class="n">soil</span> <span class="o">=</span> <span class="n">analogRead</span><span class="p">(</span><span class="n">moist</span><span class="p">);</span>
              <span class="n">soilP</span> <span class="o">=</span> <span class="n">soil</span><span class="o">/</span><span class="p">(</span><span class="n">soilWet</span><span class="o">-</span><span class="n">soilDry</span><span class="p">);</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">soilP</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">soilP</span><span class="o">&lt;=</span><span class="n">setW</span><span class="o">*</span><span class="mf">0.50</span><span class="p">){</span>
                <span class="n">waterNow</span><span class="p">();</span>
              <span class="p">}</span>
            <span class="c1">//Save RH</span>
              <span class="kt">float</span> <span class="n">rh</span> <span class="o">=</span> <span class="n">HS300x</span><span class="p">.</span><span class="n">readHumidity</span><span class="p">();</span><span class="c1">//get RH as %</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
            <span class="c1">//Save Pressure</span>
              <span class="kt">float</span> <span class="n">p</span> <span class="o">=</span> <span class="n">BARO</span><span class="p">.</span><span class="n">readPressure</span><span class="p">();</span><span class="c1">//get pressure in kPa</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
            <span class="c1">//Save VPD</span>
              <span class="kt">float</span> <span class="n">e</span> <span class="o">=</span> <span class="mf">17.2694</span><span class="o">*</span><span class="n">t</span><span class="o">/</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mf">237.3</span><span class="p">);</span><span class="c1">//figure out dew point</span>
              <span class="kt">float</span> <span class="n">eu</span> <span class="o">=</span> <span class="mf">2.71828</span><span class="p">;</span>
              <span class="kt">float</span> <span class="n">psat</span> <span class="o">=</span> <span class="mf">610.78</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">eu</span> <span class="p">,</span> <span class="n">e</span><span class="p">);</span><span class="c1">//from dewpoint figure out psat</span>
              <span class="kt">float</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">psat</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">rh</span><span class="o">/</span><span class="mi">100</span><span class="p">));</span><span class="c1">//now figure out how much your vpd is</span>
              <span class="kt">float</span> <span class="n">mpa</span> <span class="o">=</span> <span class="n">pw</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span><span class="c1">//unit conversion</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">mpa</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">mpa</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
            <span class="c1">//Save Light Readings</span>
              <span class="c1">//Max reading is 65535</span>
              <span class="kt">uint16_t</span> <span class="n">readings</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
              <span class="n">as7341</span><span class="p">.</span><span class="n">readAllChannels</span><span class="p">(</span><span class="n">readings</span><span class="p">);</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="c1">//415nm</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span><span class="c1">//445nm</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span><span class="c1">//480 nm</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span><span class="c1">//515 nm</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">6</span><span class="p">]));</span><span class="c1">//555 nm</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span><span class="c1">//590 nm</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">8</span><span class="p">]));</span><span class="c1">//630 nm</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">9</span><span class="p">]));</span><span class="c1">//680 nm</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">11</span><span class="p">]));</span><span class="c1">//IR @ 910 nm</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">10</span><span class="p">]));</span><span class="c1">//white</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span> 
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
            <span class="c1">//Save Actions</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">'0'</span><span class="p">);</span><span class="c1">//watered</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span> 
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="sc">'0'</span><span class="p">);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">'0'</span><span class="p">);</span><span class="c1">//shade</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span> 
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="sc">'0'</span><span class="p">);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">","</span><span class="p">;</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="sc">'0'</span><span class="p">);</span><span class="c1">//heat</span>
              <span class="n">strToPrint</span><span class="o">+=</span> <span class="n">String</span><span class="p">(</span><span class="sc">'0'</span><span class="p">);</span><span class="n">strToPrint</span><span class="o">+=</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
            <span class="c1">//close file and send data</span>
              <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
              <span class="n">writeBLE</span><span class="p">(</span><span class="n">strToPrint</span><span class="p">);</span>
              <span class="n">digitalWrite</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
            <span class="c1">//Delay and incriment stay before starting over</span>
              <span class="n">delay</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span>
              <span class="n">stay</span><span class="o">=</span><span class="n">stay</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"BLE.txt"</span><span class="p">,</span><span class="n">O_WRITE</span><span class="p">);</span>
          <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"r"</span><span class="p">);</span>
          <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Returning to Remote Mode in 5"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"4"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"3"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"2"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"1"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Goodbye"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
          <span class="n">digitalWrite</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="c1">//RESET THE DEVICE IF CENTRAL DISCONNECTS</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div> <h4 id="writemenu"> <a href="#writemenu" class="anchor-heading" aria-labelledby="writemenu"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> writeMenu </h4> <p>This function is called on a few times, but is separated to be easily accessible for future editing. Here you can see the list of commands a user can request of the Plant Sitter while its in receiving/remote mode</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Welcome to Plant Sitter! Choose an action:"</span><span class="p">);</span>
  <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[1] Water the Plant"</span><span class="p">);</span>
  <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[2] Move the Shade"</span><span class="p">);</span>
  <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[3] Change a Set Point"</span><span class="p">);</span>
  <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[4] Change the Schedule"</span><span class="p">);</span>
  <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[5] View/Export Data"</span><span class="p">);</span>
</code></pre></div></div> <h4 id="getdata"> <a href="#getdata" class="anchor-heading" aria-labelledby="getdata"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> getData </h4> <p>This is the workhorse function of the Plant Sitter. It logs all of the environmental data, and takes in three arguements as a function. The boolean represents if, during the measurements, we want to ask the Plant Sitter to try to fix something, like if the soil is too dry or cold. The three integers can be either 0 or 1, representing if getData was called during a point when the water was turned on, the shade was moved, or the heat was turned on.</p> <p>If the user changes one of these things, they will naturally grab a data point right beforehand to snapshot the time point any of these changes were made. However, in these instances, since the Plant Sitter is already fixing something, fix is set to false making sure other actions are called again without being requested. [otherwise getData and the function watering the plant would form a loop calling eachother.]</p> <p>The Plant Sitter will only autonomously fix things if the user isn’t present.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">getData</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">fix</span><span class="p">){</span>
  <span class="c1">//Save the time</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
    <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"DATA.txt"</span><span class="p">,</span><span class="n">FILE_WRITE</span><span class="p">);</span>
    <span class="n">DateTime</span> <span class="n">now</span> <span class="o">=</span> <span class="n">rtc</span><span class="p">.</span><span class="n">now</span><span class="p">();</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">year</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">month</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">day</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">hour</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">minute</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">second</span><span class="p">(),</span> <span class="n">DEC</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
  <span class="c1">//Save Temperature</span>
    <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">HS300x</span><span class="p">.</span><span class="n">readTemperature</span><span class="p">();</span><span class="c1">//get temp in C</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">setT</span><span class="o">*</span><span class="mf">0.45</span> <span class="o">&amp;&amp;</span> <span class="n">fix</span><span class="p">){</span> <span class="c1">//if SP 25 and temp drops to 15, [~75F to ~50F]</span>
      <span class="n">heatOn</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="c1">//Save Soil Moisture</span>
    <span class="n">soil</span> <span class="o">=</span> <span class="n">analogRead</span><span class="p">(</span><span class="n">moist</span><span class="p">);</span>
    <span class="n">soilP</span> <span class="o">=</span> <span class="n">soil</span><span class="o">/</span><span class="p">(</span><span class="n">soilWet</span><span class="o">-</span><span class="n">soilDry</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">soilP</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">soilP</span><span class="o">&lt;=</span><span class="n">setW</span><span class="o">*</span><span class="mf">0.90</span> <span class="o">&amp;&amp;</span> <span class="n">fix</span><span class="p">){</span>
      <span class="n">waterNow</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="c1">//Save RH</span>
    <span class="kt">float</span> <span class="n">rh</span> <span class="o">=</span> <span class="n">HS300x</span><span class="p">.</span><span class="n">readHumidity</span><span class="p">();</span><span class="c1">//get RH as %</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
  <span class="c1">//Save Pressure</span>
    <span class="kt">float</span> <span class="n">p</span> <span class="o">=</span> <span class="n">BARO</span><span class="p">.</span><span class="n">readPressure</span><span class="p">();</span><span class="c1">//get pressure in kPa</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
  <span class="c1">//Save VPD</span>
    <span class="kt">float</span> <span class="n">e</span> <span class="o">=</span> <span class="mf">17.2694</span><span class="o">*</span><span class="n">t</span><span class="o">/</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mf">237.3</span><span class="p">);</span><span class="c1">//figure out dew point</span>
    <span class="kt">float</span> <span class="n">eu</span> <span class="o">=</span> <span class="mf">2.71828</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">psat</span> <span class="o">=</span> <span class="mf">610.78</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">eu</span> <span class="p">,</span> <span class="n">e</span><span class="p">);</span><span class="c1">//from dewpoint figure out psat</span>
    <span class="kt">float</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">psat</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">rh</span><span class="o">/</span><span class="mi">100</span><span class="p">));</span><span class="c1">//now figure out how much your vpd is</span>
    <span class="kt">float</span> <span class="n">mpa</span> <span class="o">=</span> <span class="n">pw</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span><span class="c1">//unit conversion</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">mpa</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
  <span class="c1">//Save Light Readings</span>
  <span class="c1">//Max reading is 65535</span>
    <span class="kt">uint16_t</span> <span class="n">readings</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
    <span class="n">as7341</span><span class="p">.</span><span class="n">readAllChannels</span><span class="p">(</span><span class="n">readings</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="c1">//415nm</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span><span class="c1">//445nm</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span><span class="c1">//480 nm</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span><span class="c1">//515 nm</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">6</span><span class="p">]));</span><span class="c1">//555 nm</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span><span class="c1">//590 nm</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">8</span><span class="p">]));</span><span class="c1">//630 nm</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">9</span><span class="p">]));</span><span class="c1">//680 nm</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">11</span><span class="p">]));</span><span class="c1">//IR @ 910 nm</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">readings</span><span class="p">[</span><span class="mi">10</span><span class="p">]));</span><span class="c1">//white</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span> 
  <span class="c1">//Save Actions</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">a</span><span class="p">));</span><span class="c1">//watered</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span> 
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">b</span><span class="p">));</span><span class="c1">//shade</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">','</span><span class="p">);</span> 
    <span class="n">myFile</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">c</span><span class="p">));</span><span class="c1">//heat</span>
  <span class="c1">//close file</span>
    <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <h4 id="writecharacteristichandler"> <a href="#writecharacteristichandler" class="anchor-heading" aria-labelledby="writecharacteristichandler"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> writeCharacteristicHandler </h4> <p>This is the code behind the Plant Sitter’s ability to speak. At its highest level, it uses the WAKE variable, declared in setup, to handle the main menu choice. Wake is then used as the argument of the top layer of swtich statements.</p> <p>NOTE that there are more cases for wake than there are choices. This is because some menu choices bring the user to another menu. In these events, wake is set to numbers larger than there are main menu options so that submenu choices are handled correctly.</p> <p>Wake is initialized to be 0 in setup, and so as soon as someone sends anything to the Plant Sitter, it offers the menu of choices to the user, and switches wake to 1.</p> <p>After the menu is written, and wake=1, further inputs are expected to be integers representing choices. [Note, the user can accidentally skip to a submenu by inputting a higher integer at this version of the code, but choices of wake that are not integers or higher than possible integers will produce no response and the handler will loop.]</p> <p>While wake=1, if another 1 is chosen, the Plant Sitter will let the user know it is watering the plant. However is 2 is chosen, the Plant Sitter will first check what the position of the shade is by looking at the SD card’s text file holding the shade’s current position, and then move the shade to the opposite location [either shading or open (d for dark or b for bright)]This type of check with the SD card is the way that the Plant Sitter retains its memory despite having to power cycle itself. To that effect, the desired set point for soil moisture and temperature can be reset by accessing submenus in the handler cascade which eventually look for recognizable floats.</p> <p>Finally, the user can request that the Plant Sitter show the user its live readings by having the Plant Sitter switch over to tx mode. To do this, it first rewrites the BLE file to contain the character t instead of r, which it checks on when starting up BLE in the setup function. It counts down, and then pulls its own reset button low to power cycle itself. Now, when it runs the setup function, it not only knows to set itself up in transmission mode, but it in fact never leaves the setup function before power cycling itself again after logging, saving, and displaying 10 data points, followed by resetting BLE.txt to contain r instead of t.</p> <p>If I had more time to learn cpp, I honestly could have made this entire code its own library [which frankly it should have been for better useability but here we are]</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">char</span> <span class="n">status</span><span class="p">;</span><span class="c1">//menu-global variable that we can redeclare each time the handler is called</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">wake</span><span class="p">){</span>
    <span class="k">case</span> <span class="mi">0</span><span class="p">:</span><span class="c1">//Send Menu Options and Wait for Choice</span>
      <span class="p">{</span>
      <span class="n">writeMenu</span><span class="p">();</span><span class="c1">//Write Menu Options to App</span>
      <span class="n">wake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//you've now sent the menu options at least once</span>
      <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span><span class="c1">//handle menu selection</span>
      <span class="p">{</span>
      <span class="n">String</span> <span class="n">inputText1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">receive</span><span class="p">.</span><span class="n">value</span><span class="p">();</span> <span class="c1">// read incoming data </span>
      <span class="kt">int</span> <span class="n">choice1</span> <span class="o">=</span> <span class="n">inputText1</span><span class="p">.</span><span class="n">toInt</span><span class="p">();</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">choice1</span><span class="p">){</span>
        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span><span class="c1">//water the plant</span>
          <span class="p">{</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Applying @300 ml of Water over 5 seconds"</span><span class="p">);</span><span class="c1">//let the user know their command has been received</span>
          <span class="n">digitalWrite</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
          <span class="n">getData</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">false</span><span class="p">);</span>
          <span class="n">waterNow</span><span class="p">();</span>
          <span class="n">digitalWrite</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
          <span class="n">wake</span><span class="o">==</span><span class="mi">0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span><span class="c1">//break choice 1.1</span>
          <span class="p">}</span>
        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span><span class="c1">//Change shade position</span>
          <span class="p">{</span>
          <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"shade.txt"</span><span class="p">);</span><span class="c1">//File on pre-formattted/written SD card to store b or d for bright or dark;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">myFile</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">myFile</span><span class="p">.</span><span class="n">peek</span><span class="p">();</span><span class="c1">//there should be only be t or r. Peek allows me to check multiple times at the same location in the event a line break or extra character is present</span>
            <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="n">getData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">false</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="sc">'b'</span><span class="p">){</span>
            <span class="n">digitalWrite</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
            <span class="n">closeShade</span><span class="p">();</span>
            <span class="n">digitalWrite</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
            <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"shade.txt"</span><span class="p">,</span> <span class="n">O_WRITE</span><span class="p">);</span><span class="c1">//Overwrites the file</span>
            <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"d"</span><span class="p">);</span>
            <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">digitalWrite</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
            <span class="n">openShade</span><span class="p">();</span>
            <span class="n">digitalWrite</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
            <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"shade.txt"</span><span class="p">,</span> <span class="n">O_WRITE</span><span class="p">);</span><span class="c1">//Overwrites the file</span>
            <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"b"</span><span class="p">);</span>
            <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="n">wake</span><span class="o">==</span><span class="mi">0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span><span class="c1">//break choice 1.2</span>
          <span class="p">}</span>
        <span class="k">case</span> <span class="mi">3</span><span class="p">:</span><span class="c1">//change a set point</span>
          <span class="p">{</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"The current setpoints for Temperature and Water are: "</span><span class="p">);</span><span class="c1">//let the user know their command has been received</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">setT</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"and"</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">setW</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Change a Set Point?"</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[1] Change Temperature Set Point:"</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[2] Change Soil Moisture Set Point:"</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[3] Return to Menu"</span><span class="p">);</span>
          <span class="n">wake</span><span class="o">==</span><span class="mi">2</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span><span class="c1">//break choice 1.3</span>
          <span class="p">}</span>
        <span class="k">case</span> <span class="mi">4</span><span class="p">:</span><span class="c1">//change schedule</span>
          <span class="p">{</span>
          <span class="kt">int</span> <span class="n">dtmin</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="mi">1000</span><span class="o">/</span><span class="mi">60</span><span class="p">;</span>
          <span class="n">String</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">dtmin</span><span class="p">);</span>
          <span class="kt">int</span> <span class="n">pausetime</span> <span class="o">=</span> <span class="n">dtmin</span><span class="o">*</span><span class="n">skip</span><span class="p">;</span>
          <span class="n">String</span> <span class="n">pause</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">pausetime</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"The current measurement interval is: "</span><span class="o">+</span><span class="n">interval</span><span class="o">+</span><span class="s">" minutes."</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Automation is paused for "</span><span class="o">+</span><span class="n">pause</span><span class="o">+</span><span class="s">" more minutes."</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Change Schedule?"</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[1] Yes"</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[2] No"</span><span class="p">);</span>
          <span class="n">wake</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span><span class="c1">//break 1.4</span>
          <span class="p">}</span>
        <span class="k">case</span> <span class="mi">5</span><span class="p">:</span><span class="c1">//export data</span>
          <span class="p">{</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Would you like to disconnect from Remote Control"</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"and reconnect to in Data View?"</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[1] Stay in Remote Control"</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"[2] Go to Data View"</span><span class="p">);</span>
          <span class="n">wake</span><span class="o">=</span><span class="mi">8</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span><span class="c1">//break 1.5</span>
          <span class="p">}</span>
      <span class="p">}</span><span class="c1">//end menu choice switch</span>
      <span class="k">break</span><span class="p">;</span><span class="c1">//break wake case 1</span>
      <span class="p">}</span><span class="c1">//end wake case 1</span>
    <span class="k">case</span> <span class="mi">2</span><span class="p">:</span><span class="c1">//Change which set point?</span>
      <span class="p">{</span>
      <span class="n">String</span> <span class="n">inputText2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">receive</span><span class="p">.</span><span class="n">value</span><span class="p">();</span> <span class="c1">// read incoming data</span>
      <span class="kt">int</span> <span class="n">choice2</span> <span class="o">=</span> <span class="n">inputText2</span><span class="p">.</span><span class="n">toInt</span><span class="p">();</span>
      <span class="k">switch</span><span class="p">(</span><span class="n">choice2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">wake</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Enter New Set Point as ## C"</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span><span class="c1">//temperature</span>
        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
          <span class="n">wake</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Enter New Set Point as 0.##"</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span><span class="c1">//water</span>
        <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
          <span class="n">wake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span><span class="c1">//neither</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span><span class="c1">//break wake 2</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="mi">3</span><span class="p">:</span><span class="c1">//change temp setpoint</span>
      <span class="p">{</span>
      <span class="n">String</span> <span class="n">inputText3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">receive</span><span class="p">.</span><span class="n">value</span><span class="p">();</span> <span class="c1">// read incoming data</span>
      <span class="kt">float</span> <span class="n">tsp</span> <span class="o">=</span> <span class="n">inputText3</span><span class="p">.</span><span class="n">toFloat</span><span class="p">();</span>
      <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"tsp.txt"</span><span class="p">,</span><span class="n">O_WRITE</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">myFile</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
        <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">inputText3</span><span class="p">);}</span>
      <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
      <span class="n">writeBLE</span><span class="p">(</span><span class="s">"New Temperature Set Point: "</span><span class="o">+</span><span class="n">inputText3</span><span class="o">+</span><span class="s">" in degrees C"</span><span class="p">);</span>
      <span class="n">wake</span><span class="o">==</span><span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span><span class="c1">//break wake 3</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="mi">4</span><span class="p">:</span><span class="c1">//change water setpoint</span>
      <span class="p">{</span>
      <span class="n">String</span> <span class="n">inputText4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">receive</span><span class="p">.</span><span class="n">value</span><span class="p">();</span> <span class="c1">// read incoming data</span>
      <span class="kt">float</span> <span class="n">wsp</span> <span class="o">=</span> <span class="n">inputText4</span><span class="p">.</span><span class="n">toFloat</span><span class="p">();</span>
      <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"wsp.txt"</span><span class="p">,</span><span class="n">O_WRITE</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">myFile</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
        <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">inputText4</span><span class="p">);}</span>
      <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
      <span class="n">writeBLE</span><span class="p">(</span><span class="s">"New Watering Set Point: "</span><span class="o">+</span><span class="n">inputText4</span><span class="o">+</span><span class="s">" % to Max Soil Moisture"</span><span class="p">);</span>
      <span class="n">wake</span><span class="o">==</span><span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span><span class="c1">//break wake 4</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="mi">5</span><span class="p">:</span><span class="c1">//handle schedule submenu</span>
      <span class="p">{</span>
      <span class="n">String</span> <span class="n">inputText5</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">receive</span><span class="p">.</span><span class="n">value</span><span class="p">();</span> <span class="c1">// read incoming data</span>
      <span class="kt">int</span> <span class="n">choice5</span> <span class="o">=</span> <span class="n">inputText5</span><span class="p">.</span><span class="n">toInt</span><span class="p">();</span>
      <span class="k">switch</span><span class="p">(</span><span class="n">choice5</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span><span class="c1">// change schedule</span>
          <span class="n">wake</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Pick the new measurement interval in minutes [ints only]"</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span><span class="c1">// return to menu</span>
          <span class="n">wake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span><span class="c1">//break wake 5</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="mi">6</span><span class="p">:</span><span class="c1">//change dt</span>
      <span class="p">{</span>
      <span class="n">String</span> <span class="n">inputText6</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">receive</span><span class="p">.</span><span class="n">value</span><span class="p">();</span> <span class="c1">// read incoming data</span>
      <span class="kt">int</span> <span class="n">delayMin</span> <span class="o">=</span> <span class="n">inputText6</span><span class="p">.</span><span class="n">toInt</span><span class="p">();</span>
      <span class="n">dt</span> <span class="o">=</span> <span class="n">delayMin</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
      <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"dt.txt"</span><span class="p">,</span><span class="n">O_WRITE</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">myFile</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
        <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">inputText6</span><span class="p">);}</span>
      <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
      <span class="n">writeBLE</span><span class="p">(</span><span class="s">"New dt set to: "</span><span class="o">+</span><span class="n">inputText6</span><span class="o">+</span><span class="s">" minutes"</span><span class="p">);</span>
      <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Skip automation for how many minutes?"</span><span class="p">);</span>
      <span class="n">wake</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span><span class="c1">//break wake 6</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="mi">7</span><span class="p">:</span><span class="c1">//change skip</span>
      <span class="p">{</span>
      <span class="n">String</span> <span class="n">inputText7</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">receive</span><span class="p">.</span><span class="n">value</span><span class="p">();</span> <span class="c1">// read incoming data</span>
      <span class="kt">int</span> <span class="n">skipMin</span> <span class="o">=</span> <span class="n">inputText7</span><span class="p">.</span><span class="n">toInt</span><span class="p">();</span>
      <span class="kt">float</span> <span class="n">skipNum</span> <span class="o">=</span> <span class="n">skipMin</span><span class="o">/</span><span class="n">dt</span><span class="p">;</span>
      <span class="n">skip</span> <span class="o">=</span> <span class="n">round</span><span class="p">(</span><span class="n">skipNum</span><span class="p">);</span>
      <span class="n">String</span> <span class="n">skipLog</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">skip</span><span class="p">);</span>
      <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"skip.txt"</span><span class="p">,</span><span class="n">O_WRITE</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">myFile</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
        <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">skipLog</span><span class="p">);}</span>
      <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
      <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Automation will be paused for "</span><span class="o">+</span><span class="n">inputText7</span><span class="o">+</span><span class="s">" more minutes"</span><span class="p">);</span>
      <span class="n">wake</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="mi">8</span><span class="p">:</span><span class="c1">//confirm switching mode</span>
      <span class="n">String</span> <span class="n">inputText8</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">receive</span><span class="p">.</span><span class="n">value</span><span class="p">();</span> <span class="c1">// read incoming data </span>
      <span class="kt">int</span> <span class="n">choice8</span> <span class="o">=</span> <span class="n">inputText8</span><span class="p">.</span><span class="n">toInt</span><span class="p">();</span>
      <span class="k">switch</span><span class="p">(</span><span class="n">choice8</span><span class="p">){</span>
        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">wake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Plant Sitter is Getting Ready to Switch to Data View&amp;Export Mode"</span><span class="p">);</span>
          <span class="n">getData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Plant Sitter is Saving State"</span><span class="p">);</span>
          <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"BLE.txt"</span><span class="p">,</span><span class="n">O_WRITE</span><span class="p">);</span><span class="c1">//File on pre-formattted/written SD card to store t or r;</span>
          <span class="n">myFile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"t"</span><span class="p">);</span>
          <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Plant Sitter will restart in Data View&amp;Export Mode in"</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"10"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"9"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"8"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"7"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"6"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"5"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"4"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"3"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"2"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"1"</span><span class="p">);</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
          <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Goodbye!"</span><span class="p">);</span>
          <span class="n">digitalWrite</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span><span class="c1">//cycle uC</span>
          <span class="k">break</span><span class="p">;</span><span class="c1">//breaks case 2</span>
      <span class="p">}</span><span class="c1">//ends subchoice switch</span>
      <span class="k">break</span><span class="p">;</span><span class="c1">//ends case 8</span>
  <span class="p">}</span><span class="c1">//end wake switch</span>
</code></pre></div></div> <h4 id="waternow"> <a href="#waternow" class="anchor-heading" aria-labelledby="waternow"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> waterNow </h4> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pumpPin</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span><span class="c1">//time required to deliver 300 ml of water based on calculations/assumptions below</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pumpPin</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
  <span class="c1">//Time calculation for water</span>
    <span class="cm">/*Assumptions
      Pump rated at 0.1 amps
      Assume 3 V applied 
      It takes 10 Pascals to lift water 1 mm
      Assume pump located 0.5 m below delivery point
      ==============================================
      P=IV -&gt; 0.3 Watts == 0.3 N*m/s
      Must exert 5000 Pa == 5000 N/m*m
      Unit wise: (N*m*m*m) / (N*s) - &gt; m^3 / s
      0.3/5000 = 0.00006 cubic meters of water per second
      or 60 ml per second */</span>
</code></pre></div></div> <h4 id="closeshade"> <a href="#closeshade" class="anchor-heading" aria-labelledby="closeshade"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> closeShade </h4> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">shade1</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span><span class="c1">//Set up motor direction</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">shade2</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">shade0</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span><span class="c1">//a resistor over motor pins will ensure the motor speed is appropriate to move in 5 seconds</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">shade0</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
  <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Shade Closed"</span><span class="p">);</span>
</code></pre></div></div> <h4 id="openshade"> <a href="#openshade" class="anchor-heading" aria-labelledby="openshade"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> openShade </h4> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">shade1</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span><span class="c1">//Set up motor direction</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">shade2</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">shade0</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span><span class="c1">//a resistor over motor pins will ensure the motor speed is appropriate to move in 5 seconds</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">shade0</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
  <span class="n">writeBLE</span><span class="p">(</span><span class="s">"Shade Opened"</span><span class="p">);</span>
</code></pre></div></div> <h4 id="heaton"> <a href="#heaton" class="anchor-heading" aria-labelledby="heaton"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> heatOn </h4> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">heatPin</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">heatPin</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div> <h4 id="getdtskip"> <a href="#getdtskip" class="anchor-heading" aria-labelledby="getdtskip"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> getDtSkip </h4> <p>This function is responsible for determining how frequently the Plant Sitter should log data data. It is sort of a “pseudo clock” that exists on a higher level than the microcontroller’s true clock or the rtc. Similar to the delay value of the Blink’s loop function.</p> <p>Note we don’t use the RTC for this, we just assume that on time scales of 1 minute upwards to multiple minutes or hours, that its “accurate enough.”</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"dt.txt"</span><span class="p">);</span><span class="c1">//File on pre-formattted/written SD card to store t or r;</span>
  <span class="n">String</span> <span class="n">timeInt</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">myFile</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
      <span class="n">timeInt</span><span class="o">=</span><span class="n">timeInt</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">myFile</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">timeInterval</span> <span class="o">=</span> <span class="n">timeInt</span><span class="p">.</span><span class="n">toInt</span><span class="p">();</span>
  <span class="n">dt</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="n">timeInterval</span><span class="p">;</span>
  <span class="c1">///now get skip///</span>
  <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"skip.txt"</span><span class="p">);</span><span class="c1">//File on pre-formattted/written SD card to store t or r;</span>
  <span class="n">String</span> <span class="n">ignore</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">myFile</span><span class="p">.</span><span class="n">available</span><span class="p">()){</span>
      <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">myFile</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
  <span class="n">skip</span> <span class="o">=</span> <span class="n">ignore</span><span class="p">.</span><span class="n">toInt</span><span class="p">();</span>
</code></pre></div></div> <h4 id="loop"> <a href="#loop" class="anchor-heading" aria-labelledby="loop"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> loop </h4> <p>This is our listener function that the microcontroller only gets to if its in receive/remote/RX mode. BLE.poll() listens for data over BLE, but will timeout after its argument number of milliseconds has passed. If no requests have come by then, it will log data every dt milliseconds and either try to fix any issues it notices if automatiion is active, or inciment its skip index and not fix things if the number of skips is still greater than 0.</p> <p>Note that, if a user is connected to the remote and makes no choices for a time period greater than dt, the Plant Sitter will be unable to automatically log data as it would be busy listening for BLE responses in the handler function!</p> <p>We hope that a user would try to make their changes/requests in either under that time frame, or chose actions that inherently log data themselves [ie watering the plant, heating the plant, or changing the shade postion all call getData since the request for such events themselves are logged]. Additionally, if the user is requesting to view/export data, as long as they reconnect to the Plant Sitter in a reasonable amount of time, data is still logged while the Plant Sitter is transmitting readings.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">//while we're not activley taking a measurement, see if there are incoming messages over BLE</span>
    <span class="n">BLE</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span><span class="c1">//wait for an event over BLE until we need to use thinking power to grab the new data set</span>
  <span class="c1">//When its about time to take a measurement, get the data, and decrease the skip index</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">getData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">getData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">false</span><span class="p">);</span>
      <span class="n">skip</span> <span class="o">=</span> <span class="n">skip</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"skip.txt"</span><span class="p">,</span><span class="n">O_WRITE</span><span class="p">);</span>
      <span class="n">String</span> <span class="n">count</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">skip</span><span class="p">);</span>
      <span class="n">myFile</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
      <span class="n">myFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div> <h3 id="validation"> <a href="#validation" class="anchor-heading" aria-labelledby="validation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Validation </h3> <p>The easiest way to validate that this code works is to copy it to your own Arduino IDE 2.0.4 and compile it yourself. Just make sure all libraries included are installed in your IDE as well. To copy and paste this code or download it yourself, please visit the Git Hub repository and find the .ino file in the ArduinoFirmware folder.</p> <p>Or Click the following button</p> <p><a href="https://github.com/mrenny/ArduinoMC/blob/main/PlantSitterFirmware/microcredential.ino" class="btn btn-outline">Go to Code</a></p> <h3 id="future-work"> <a href="#future-work" class="anchor-heading" aria-labelledby="future-work"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Future Work </h3> <p>Outside the scope of the requirements of the Arduino Microcredential, future work that would make the Plant Sitter a better device would be to address the folowing items:</p> <ul> <li>Automate a regular warning about if the water reservoir is low</li> <li>Automate plant shading if VPD is too extreme to reduce wilt</li> <li>Include solar pannel in device design to increase lifespan</li> <li>Report SD card free space and Battery level when logging data <ul style="list-style-type:none"> <li> battery level may increase in intense sun </li> <li> data capcity may go up if previously had an offloading event </li> </ul> </li> <li>Make an extra layer of questioning in the View/Export selection of the handler to ask for “what range of data is being requested” <ul style="list-style-type:none"> <li> Based on how many hours prior to current date the user wants to export </li> <li> We can first populate the data file with a comma separated header </li> <li> This will allow a function to seek through the first few comma separated values [which are the year, month, date, hour, and minute] after every new line character </li> <li> As it is checking, it could write the data on each line with a desired date to BLExAR [including the date] so that we can then use BLExAR to email it to ourselves </li> <li> Because BLExAR doesn't allow a custom x axis, it would be difficult to read the data from the app with the correct temporal resolution without plotting the emailed data in another software</li> </ul> </li> <li>Allow for automation during in TX/Data View&amp;Export mode</li> <li>Reformatting to cheaper ESP32-based boards like the Firebeetle which also offer WiFi with BLE. If a reliable WiFi connection is expected Wifi link with AWS could allow <ul style="list-style-type:none"> <li> Removing the SD card slot </li> <li> UI/Graphing components hosted on a website accessible across the world </li> <li> Machine Learning based on inputs </li> </ul> </li> </ul><hr /> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
